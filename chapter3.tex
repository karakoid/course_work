\chapter{ПОСТРОЕНИЕ MPC-РЕГУЛЯТОРА В ЗАДАЧЕ УПРАВЛЕНИЯ КВАДРОКОПТЕРОМ}\label{chap3}

	В текущей главе рассмотрим математическую модель квадрокоптера, этапы, необходимые для формулирования решаемой MPC-регулятором задачи оптимизации, построение MPC-регулятора с помощью Model Predictive Control Toolbox, рассмотрим структуру системы, ее настройку, и проведем симуляцию полученной модели в Simulink.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Математическая модель квадрокоптера}\label{3sec:quadcopter math model}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{figure}[h]
\centering
\includegraphics{quadcopter_model}
\caption{Модель квадрокоптера}
\end{figure}

	Квадрокоптер может свободно двигаться во всех трех направлениях во время своего полета. Это значит, что нам необходимо ввести шесть степеней свободы, чтобы полностью описать динамику квадрокоптера. Обозначим с помощью $ x, y, z $ позицию квадрокоптера в пространстве, где $ x $ и $ y $ отвечают за горизонтальную плоскость, а $ z $ --- за вертикальную. С помощью $ \varphi, \theta, \psi $ обозначим углы вращения квадрокоптера относительно своих осей: $ \psi $ отвечает за угол поворота (вращение относительно оси $ z $), $ \varphi $ отвечает за крен (вращение относительно оси $ y $), $ \theta $ отвечает за угол наклона квадрокоптера (вращение относительно оси $ x $). \par
	Каждый из моторов $ M_1, M_2, M_3, M_4 $ генерирует силы тяги $ f_1, f_2, f_3, f_4 $ и крутящие моменты $ \tau_1, \tau_2, \tau_3, \tau_4 $ соответственно. Силы и крутящие моменты могут быть изменены путем повышения или понижения напряжения на моторы. В итоге, создаются три крутящих момента $ \tau_\varphi, \tau_\theta, \tau_\psi $:
\begin{align}
	&\tau_\theta = (f_2 - f_4)l,\\
	&\tau_\varphi = (f_1 - f_3)l,\\
	&\tau_\psi = \sum_{i = 1}^4 \tau_i,
\end{align}
где $ l $ --- это расстояние от каждого из моторов до центра квадрокоптера. А результирующая сила $ u = f_1 + f_2 + f_3 + f_4 $ позволяет свободно изменять позицию и ориентацию квадрокоптера в пространстве. \par
	Пусть $ \tau = [\tau_\theta \; \tau_\varphi \; \tau_\psi]' $ будет общим вектором крутящих моментов, $ \eta = [\theta \; \varphi \; \psi]' $ будет вектором углового смещения, а $ J $ --- матрица инерции. Тогда вращательная динамика квадрокоптера может быть описана следующим образом:
\begin{equation}
	\tau = J\ddot{\eta} + J\dot{\eta} - \frac{1}{2} \frac{\partial}{\partial \eta} (\dot{\eta}'J\dot{\eta}),
\end{equation}
что может быть переписано как
\begin{equation}
	\ddot{\eta} = \tilde{\tau}, 
\end{equation}
где $ \tilde{\tau} = [\tilde{\tau_\theta} \; \tilde{\tau_\varphi} \; \tilde{\tau_\psi}]' $ новые входные данные. С помощью вращательных преобразований между системой $ I $ (см. Рис. 3.1) и центром масс квадрокоптера, получим систему уравнений, описывающих его динамику:
\begin{align}
	&m\ddot{x} = - u\sin{\theta} - \beta\dot{x},\\
	&m\ddot{y} = u\cos{\theta}\sin{\varphi} - \beta\dot{y},\\
	&m\ddot{z} = u\cos{\theta}\cos{\varphi} - \beta\dot{z},\\
	&\ddot{\theta} = \tilde{\tau_\theta},\\
	&\ddot{\varphi} = \tilde{\tau_\varphi},\\
	&\ddot{\psi} = \tilde{\tau_\psi},
\end{align}
где $ \beta $ является фактором демпфирования, принимая во внимание эффекты трения. Нелинейная динамическая модель имеет двеннадцать входных данных (шесть позиций и шесть скоростей) и четыре выходных данных (результирующая сила и три крутящих момента), связанных соотношениями (3.6) - (3.11).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Построение линейного MPC}\label{3sec:MPC design}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Формулирование и построение MPC-регулятора}
\label{Formulation and building process of MPC}


	Для того, чтобы построить линейный MPC-регулятор для квадрокоптера, необходимо линеаризовать нелинейную динамическую систему (3.6) - (3.11) в положении равновесия. Результирующее линейное непрерывное пространство состояний нужно перевести в дискретное с периодом квантования $ T_s $
\begin{align}
	&\xi (k + 1) = A\xi (k) + Bu(k),\\
	&y(k) = C\xi (k) + Du(k),
\end{align}
где $ \xi (k) = [x \; \dot{x} \; y \; \dot{y} \; z \; \dot{z} \; \varphi \; \dot{\varphi} \; \theta \; \dot{\theta} \; \psi \; \dot{\psi}]'  \in \mathbb{R}^{12} $ --- вектор состояния системы, $ y(k) \in \mathbb{R}^{12} $ --- вектор выходных данных, матрицы $ A, B, C, D $ --- это матрицы подходящих размеров, полученных в процессе линеаризации системы (3.6) - (3.11). \par
	Для формулирования линейного MPC используется Model Predictive Control Toolbox для Matlab, где управление получено с помощью решения оптимизационной задачи
\begin{align}
	&\min_{\Delta u} \sum_{i = 0}^{N_L - 1}(\sum_{j = 1}^{n_y}| \omega_j^y[y_j(k + i + 1 | k) - r_j(k + i + 1)]|^2 + \sum_{j = 1}^{n_u}|\omega _j^{\Delta u} \Delta u_j(k + i | k)|^2 + \rho_\epsilon \epsilon ^2),\\
	&u_j^{min} \leq u_j(k + i | k) \leq u_j^{max}, \; j = 1, ... , n_u, \\
	&y_j^{min} - \epsilon V_j^{y, min} \leq y_j(k + i + 1| k) \leq y_j^{max} + \epsilon V_j^{y, max}, \; j = 1, ... , n_y, \\
	&\Delta u(k + h | k) = 0, \; h = N_{Lu}, ... , N_L, \; \epsilon \geq 0,
\end{align}
для всех $ i = 0, ..., N_L - 1 $ в отношении последовательности входных приращений $ \{ \Delta u(k | k), ... , \Delta u(N_{Lu} - 1 + k | k) \} $ и слабой переменной $ \epsilon $. Индекс $ "(\cdot)_j" $ обозначает j-ую компоненту вектора, $ "(k + i | k)" $ обозначает предсказанное значение в момент времени $ k + i $, основываясь на текущем моменте времени $ k $, $ r(k) $ --- значение эталонных выходных данных (output reference), $ V^{y, min}, V^{y, max} $ --- неотрицательные векторы-константы, необходимые для релаксации выходных ограничений, $ n_y = 12 $ количество выходных значений, $ n_u = 4 $ количество входных значений. Линейный MPC-регулятор устанавливает значение $ u(k) = u(k - 1) + \Delta u^\ast (k | k) $, где $ \Delta u^\ast (k | k) $ является первым элементом последовательности.


\subsection{Настройка MPC и проверка результатов}
\label{MPC tuning and validating}

\begin{figure}[h]
\centering
\includegraphics[scale=0.5]{schema}
\caption{Структура системы}
\end{figure}

	Линейный MPC-регулятор настроен следующим образом. Устанавливаем $ u_j^{min} = -6N_m, \; u_j^{max} = 6N_m, \; j = 1, 2, 3, \; u_4^{min} = -6N, \; u_4^{max} = 6N, \; \omega _{i, j}^{\Delta u} = 0.1 \; \forall j = 1, ... , 4, \; i = 0, ... , N_L - 1$. Для выходных переменных устанавливаем нижнюю границу $ y_5^{min} = 0 $ для переменной $ z $, верхнюю и нижнюю границу $ y_{7,9}^{max} = -y_{7, 9}^{min} = \frac{\pi}{12} $ для крена и угла наклона. Веса на выходные переменные равны $ \omega _j^y = 1, \; j \in \{ 1, 2, 3, 4 \} $ для $ x, \dot{x}, y, \dot{y} $ соответственно, и $ \omega _j^y = 10 $ для всех оставшихся. Горизонт прогноза (prediction horizon) $ N_L = 20 $, горизонт управления (control horizon) $ N_{Lu} = 3 $. Период квантования $ T_s = 0.05s $. Оставшиеся параметры $ V^{y, min}, \; V^{y, max}, \; \rho_{\epsilon} $ устанавливаются по умолчанию с помощью Model Predictive Control Toolbox. \par
	Симуляция нелинейной системы квадрокоптера (3.6) - (3.11) проводилась под эффектом MPC-регулятора (3.14) - (3.17) с помощью Simulink и Model Predictive Control Toolbox. Дополнительные блоки на Рис. 3.2 были добавлены для вывода результатов. \par
	
\begin{figure}[h]
\centering
\includegraphics[scale=0.28]{output}
\caption{Графики значений выходных данных}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[scale=0.28]{controls}
\caption{Графики значений входных данных}
\end{figure}

	
	На Рис. 3.3 показаны результаты симуляции, полученные за счет отслеживания выходных данных. Начальным значением состояния системы являлся нулевой вектор, а ограничениями на положения $ x, y, z $ были значения, отклоняющиеся от желаемых на $ \pm 2 $. К концу симуляции необходимо было достичь определенных значений положения квадрокоптера: $ x = 15, \; y = 10, \; z = 5 $, что можно увидеть на Рис. 3.3. На Рис. 3.4 показаны значения результирующей силы и трех крутящих моментов. Необходимо отметить, что $ u $ в начальный момент времени не равняется нулю, что связано с задачей удержать квадрокоптер в состоянии полета.
	
	
\section{Выводы}


	В данной курсовой работе происходило ознакомление с базовыми принципами и алгоритмами управления по прогнозирующей модели, задачами оптимального управления и некоторыми численными методами их решения, обучением с подкреплением, методами построения MPC-регулятора на основе методов машинного обучения. Был построен MPC-регулятор для задачи управления квадрокоптером, была проведена его настройка и были освещены результаты проведения симуляции.